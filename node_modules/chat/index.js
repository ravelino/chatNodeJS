var redis = require('redis');
var sio = require('socket.io');

module.exports = function(server) {
   
   var mensagens = [];
   
   var io = sio.listen(server);
   
   function armazenarMensagem(nick, mensagem) {
	  var msg = {
		hora: new Date().toLocaleTimeString(),
		nome: nick,
		texto: mensagem
	  };

	  mensagens.push(msg);

	  if (mensagens.length > 10) {
		mensagens.splice(0, 1);
	  }

	  return msg;
	}

	function enviarMensagens(client) {
	  mensagens.forEach(function(msg) {
		client.emit('mensagem', msg);
	  });
	}
	
	var consumer = redis.createClient();
	var publisher = redis.createClient();

	consumer.subscribe('mensagens');
	
	consumer.on('message', function(channel, message) {
	  var msg = JSON.parse(message);
	  io.sockets.emit('mensagem', msg);
	});
   
	io.sockets.on('connection', function(socket) {

	  socket.on('set nick', function(name) {
		socket.set('nick', name, function() {
		  socket.emit('ready');
		  enviarMensagens(socket);
		});
	  });

	  socket.on('mensagem', function(mensagem) {
		
		socket.get('nick', function(err, name) {
		  var msg = armazenarMensagem(name, mensagem);
		  publisher.publish('mensagens', JSON.stringify(msg));
		})
	  });
	});
	
	return true;
};
